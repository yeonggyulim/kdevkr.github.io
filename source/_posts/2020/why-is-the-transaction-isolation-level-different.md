---
    title: ì™œ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì´ ë‹¤ë¥´ì§€?
    date: 2020-02-08
    categories:
        - ê°œë°œ ì´ì•¼ê¸°
        - ì´ìŠˆ
    tags:
        - ìŠ¤í”„ë§
        - ë°ì´í„°ë² ì´ìŠ¤
        - íŠ¸ëœì­ì…˜
---

## ë“¤ì–´ê°€ë©°
í”„ë¡œì íŠ¸ ê°œë°œí•˜ë˜ ë„ì¤‘ ë°œìƒí•œ ìƒí™©ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í”„ë¡œë¯¸ìŠ¤ë¥¼ í†µí•´ HTTP ìš”ì²­ì„ ìˆœì°¨ì ìœ¼ë¡œ ì—°ê²°í•˜ë˜ ë¶€ë¶„ì—ì„œ ì„œë²„ ì¸¡ìœ¼ë¡œë¶€í„° ì˜¤ë¥˜ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤. í•´ë‹¹ APIëŠ” ì–´ë–¤ ì˜µì…˜ì„ ì„¤ì •í•˜ê³  í•´ì œí•˜ëŠ” ê²ƒì´ì—ˆëŠ”ë° íŠ¹ì • ì¡°ê±´í•˜ì— ê·¸ ì˜µì…˜ì„ ìœ ì¼í•˜ê²Œ ì„¤ì •í•´ì•¼í•˜ë¯€ë¡œ ì˜µì…˜ì„ ì„¤ì •í•˜ê¸° ì „ì— ìœ ì¼í•œì§€ ì²´í¬í•˜ë„ë¡ ë˜ì–´ìˆìŠµë‹ˆë‹¤.  

**_ì—¬ê¸°ì„œ ì ê¹!_**
í”„ë¡œë¯¸ìŠ¤ë¡œ ì—°ê²°í•˜ì—¬ ì„œë²„ì— ìˆœì°¨ì ìœ¼ë¡œ ìš”ì²­í•œ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. í•´ë‹¹ APIëŠ” ì˜µì…˜ì„ ì„¤ì •í•˜ê³  í•´ì œí•  ìˆ˜ ìˆëŠ”ë° ì´ë¯¸ ì˜µì…˜ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²ƒì„ í•´ì œí•´ì•¼ ë‹¤ì‹œ ì„¤ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. 

ê·¸ë˜ì„œ í”„ë¡œë¯¸ìŠ¤ë¡œ ì—°ê²°í•˜ì—¬ ë¨¼ì € ì„¤ì •ë˜ì–´ìˆëŠ” ì˜µì…˜ì„ í•´ì œí•˜ë„ë¡ ìš”ì²­í•˜ì˜€ê³  ì„œë²„ëŠ” í•´ë‹¹ ìš”ì²­ì— ì˜í•´ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆë‹¤ê³  ì‘ë‹µí•˜ì˜€ìŠµë‹ˆë‹¤.

> ì´ ê³¼ì •ì—ì„œëŠ” ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì˜µì…˜ì´ í•´ì œë˜ì—ˆë‹¤ëŠ” ì‘ë‹µì— ëŒ€í•˜ì—¬ ë‹¤ì‹œí•œë²ˆ ì„œë²„ì— ì˜µì…˜ì„ ì„¤ì •í•˜ê² ë‹¤ê³  ìš”ì²­í–ˆì„ ë•Œ ì´ë¯¸ ì„¤ì •ëœ ì˜µì…˜ì´ ìˆë‹¤ëŠ” ì˜¤ë¥˜ë¥¼ ì‘ë‹µí•˜ì˜€ìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ ì˜¤ë¥˜ë¥¼ ì‘ë‹µí–ˆë‹¤ëŠ” ê²ƒì€ ë‘ë²ˆì§¸ ìš”ì²­ì—ì„œ ì§„í–‰ë˜ì—ˆë˜ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì´ì „ ìš”ì²­ì— ì˜í•´ ì»¤ë°‹ëœ ë‚´ìš©ì´ ë°˜ì˜ë˜ê¸° ì „ì˜ ë°ì´í„°ë¡œ ì½ê¸° ë•Œë¬¸ì´ë¼ê³  ì˜ˆìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ ì´ì œ ìš°ë¦¬ëŠ” íŠ¸ëœì­ì…˜ ê°„ì˜ ê²©ë¦¬ ë ˆë²¨ì„ í™•ì¸í•´ë´ì•¼í•©ë‹ˆë‹¤.

## íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨  
ë§¨ ì²˜ìŒì—ëŠ” ì˜µì…˜ì„ ìœ ì¼í•˜ê²Œ ì„¤ì •í•  ìˆ˜ ìˆëŠ”ì§€ ì²´í¬í•˜ëŠ” ë¶€ë¶„ì´ ì´ìƒí•œì§€ í™•ì¸í–ˆìœ¼ë‚˜ ê·¸ ë¶€ë¶„ì€ ì •ìƒì´ì—ˆìŠµë‹ˆë‹¤. ê·¸ ë‹¤ìŒì— ì˜ì‹¬í•œ ë¶€ë¶„ì´ íŠ¸ëœì­ì…˜ì´ì—ˆìŠµë‹ˆë‹¤.

### PostgreSQL
PostgreSQLì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- Read uncommitted
- Read committed
- Repeatable read
- Serializable

ì´ ì¤‘ì—ì„œ SQL í‘œì¤€ì—ì„œ Dirty Readê°€ ê°€ëŠ¥í•œ ë ˆë²¨ì€ `Read uncommitted`ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ PostgreSQLì˜ ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ ì°¾ì•„ë³´ì•˜ìŠµë‹ˆë‹¤. 

> Read Committed is the default isolation level in PostgreSQL.

í¬ìŠ¤íŠ¸ê·¸ë ˆì˜ ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì€ Read Committed.

> ê·¸ëŸ¬ë©´, Dirty Readê°€ ì•ˆë˜ì•¼í•˜ëŠ”ë°?.. ë­ê°€ ë¬¸ì œì¸ê±°ì•¼...

ì ê¹ë§Œìš”, Read uncommittedì— Dirty Read ë ˆë²¨ì— _Allowed, but not in PG_ ë¼ê³  í‘œì‹œë˜ì–´ìˆìŠµë‹ˆë‹¤. ì´ ì˜ë¯¸ëŠ” í¬ìŠ¤íŠ¸ê·¸ë ˆ ë°–ì—ì„œëŠ” Dirty Readë¥¼ í—ˆìš©í•œë‹¤ëŠ” ë§ì…ë‹ˆë‹¤.

> ê·¸ëŸ¬ë©´ Postgre ì•ë‹¨ì—ì„œ Read uncommittedë¥¼ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ë¡œ ì‚¬ìš©í•˜ëŠ” ê±°ì–ì•„?

### HikariCP DataSource
HikariCPë¥¼ ì»¤ë„¥ì…˜ í’€ë¡œ ì‚¬ìš©í•˜ê³  ìˆì–´ ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì´ ë¬´ì—‡ì¸ì§€ ì‚´í´ë´…ì‹œë‹¤. 

> ğŸ” transactionIsolation
This property controls the default transaction isolation level of connections returned from the pool. If this property is not specified, the default transaction isolation level defined by the JDBC driver is used. Only use this property if you have specific isolation requirements that are common for all queries. The value of this property is the constant name from the Connection class such as TRANSACTION_READ_COMMITTED, TRANSACTION_REPEATABLE_READ, etc. Default: driver default

transactionIsolation ì˜µì…˜ì„ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ JDBC ë“œë¼ì´ë²„ì˜ ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì„ ì‚¬ìš©í•œë‹¤ê³  í•©ë‹ˆë‹¤.

### @Transactional
ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ìŠ¤í”„ë§ì„ ê¸°ë°˜ì´ê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¥¼ ìŠ¤í”„ë§ì—ê²Œ ìœ„ì„í•˜ì˜€ìŠµë‹ˆë‹¤. 

> The isolation level is ISOLATION_DEFAULT.

ê·¸ëŸ¬ë©´ ISOLATION_DEFAULTì€ ë­˜ê¹Œìš”?

`spring-tx` ëª¨ë“ˆì˜ TransactionDefinition ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚´í´ë³´ë©´ ISOLATION_DEFAULTëŠ” ê°œë³„ì ì¸ DB ì„¤ì •ì„ ë”°ë¥´ê¸° ë•Œë¬¸ì— PostgreSQLë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©´ ISOLATION_READ_COMMITTEDì´ ì ìš©ëœë‹¤ê³  ë´ì•¼í•©ë‹ˆë‹¤.

ê·¸ë˜ì„œ í˜¹ì‹œë‚˜ í•˜ëŠ” ë§ˆìŒì— í•´ë‹¹ ë¦¬íŒŒì§€í† ë¦¬ í•¨ìˆ˜ì— @Transactionalì„ ì„ ì–¸í•˜ê³  Isolation.READ_COMMITTEDì„ ëª…ì‹œí•´ë³´ì•˜ìŠµë‹ˆë‹¤.

```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public Integer settleable(String peId, String rId) throws SQLException {
    return createStoredFunction("program_enroll$settleable")
            .addString(peId)
            .addString(rId)
            .execute(Integer.class);
}
```

ê²°ê³¼ëŠ” ì˜¤ë¥˜ê°€ ë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ê±´ ë¬´ìŠ¨ ìƒí™©ì¼ê¹Œìš”?...

ë°ì´í„°ë² ì´ìŠ¤ì˜ ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì´ READ_COMMITTED,
HikariCPì˜ ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì€ JDBC ë“œë¼ì´ë²„ì˜ ê¸°ë³¸ê°’,
ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì˜ ê¸°ë³¸ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì€ ê°œë³„ì ì¸ DBë¥¼ ë”°ë¥¸ë‹¤.

ì•„ PostgreSQL JDBC ë“œë¼ì´ë²„ë¥¼ ì‚´í´ë³´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

### PgConnection  
ë‹¤ìŒì€ PgConnection í´ë˜ìŠ¤ì˜ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

```java
public int getTransactionIsolation() throws SQLException {
    checkClosed();

    String level = null;
    final ResultSet rs = execSQLQuery("SHOW TRANSACTION ISOLATION LEVEL"); // nb: no BEGIN triggered
    if (rs.next()) {
      level = rs.getString(1);
    }
    rs.close();

    // TODO revisit: throw exception instead of silently eating the error in unknown cases?
    if (level == null) {
      return Connection.TRANSACTION_READ_COMMITTED; // Best guess.
    }

    level = level.toUpperCase(Locale.US);
    if (level.equals("READ COMMITTED")) {
      return Connection.TRANSACTION_READ_COMMITTED;
    }
    if (level.equals("READ UNCOMMITTED")) {
      return Connection.TRANSACTION_READ_UNCOMMITTED;
    }
    if (level.equals("REPEATABLE READ")) {
      return Connection.TRANSACTION_REPEATABLE_READ;
    }
    if (level.equals("SERIALIZABLE")) {
      return Connection.TRANSACTION_SERIALIZABLE;
    }

    return Connection.TRANSACTION_READ_COMMITTED; // Best guess.
}
```

ì—­ì‹œë‚˜ íŠ¸ëœì­ì…˜ ë ˆë²¨ì„ ê°€ì ¸ì˜¤ì§€ ëª»í•˜ë©´ TRANSACTION_READ_COMMITTEDì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ì—¬ê¸°ì„œ ì¶”ì¸¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

1. ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ì´ READ_UNCOMMITTEDìœ¼ë¡œ ì„¤ì • ë˜ì–´ìˆë‹¤.
2. Connectionì—ì„œ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ë ˆë²¨ í™•ì¸ ì‹œ READ_UNCOMMITTEDì„ ì‘ë‹µ ë°›ëŠ”ë‹¤. 

> ìš°ì„ ì€ OKKYì— [ì§ˆë¬¸](https://okky.kr/article/677130) í•˜ì˜€ìŠµë‹ˆë‹¤.
> ë‹µë³€ì´ ë‹¬ë¦¬ë©´ ì¶”ê°€ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.


## ì°¸ê³ 

- [Postgres Transaction Isolation](https://www.postgresql.org/docs/9.6/transaction-iso.html)
- [HikariCP Configuration](https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby)
- [Spring @Transactional](https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction-declarative-attransactional-settings) 

